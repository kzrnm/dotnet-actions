name: Publish NuGet & Release

on:
  workflow_call:
    inputs:
      artifact-name:
        description: Artifact name
        required: true
        type: string
      version:
        description: Build version
        required: true
        type: string
      is-prerelease:
        description: "if true, Create release as prerelease"
        required: false
        default: false
        type: boolean
    secrets:
      NUGET_KEY:
        description: "NuGet API key"
        required: true
jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.artifact-name }}
          path: dist
      - name: Upload nuget
        run: dotnet nuget push "./dist/*.nupkg" --skip-duplicate --source https://api.nuget.org/v3/index.json --api-key ${{ secrets.NUGET_KEY }}
      - name: New tag
        id: tag-version
        run: |
          TAG="v${{ inputs.version }}"
          echo "new-tag=$TAG" >> "$GITHUB_OUTPUT"
          git tag "$TAG"
          git push origin "$TAG"
      - name: Create release
        uses: ncipollo/release-action@v1
        id: create-release
        with:
          tag: ${{ steps.tag-version.outputs.new-tag }}
          name: Version ${{ inputs.version }}
          body: https://github.com/${{ github.repository }}/blob/${{ steps.tag-version.outputs.new-tag }}/CHANGELOG.md
          artifacts: "./dist/*.nupkg,./dist/*.snupkg"
          prerelease: ${{ inputs.is-prerelease }}
